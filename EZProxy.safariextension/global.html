<!DOCTYPE HTML>
<html>
<head>
  <title>WashU Proxy</title>
  <script src="scripts/proxy.js" type="text/javascript"></script>
  <script src="scripts/journals.js" type="text/javascript"></script>
  <script src="scripts/util.js" type="text/javascript"></script>
  <script type="text/javascript">

    // add listener to command and validate.
    safari.application.addEventListener("navigate", autoReload, false);
    safari.application.addEventListener("command", performCommand, false);

    // set for the default proxy, default proxy is WUSTL.
    var selectedProxy = defaultProxy;
    var proxyUrl = proxyList[selectedProxy];
    var proxyDomain = proxyUrl;

    function autoReload(event){
      //load proxy only in journal sites.
      if (validateUrl(selectedProxy, event.target.url)){
        event.target.url = addProxyUrl(event.target.url);
      }
    }

    // Function to perform when event is received
    function performCommand(event) {
      // Make sure event comes from the button
      if (event.command === "useProxy") {
          // get current active tab 
          var curTab = event.target.browserWindow.activeTab;
          // get url of current active tab
          var url = curTab.url;
          // manually load proxy as long as the url is not empty
          // and proxy is not added.
          if (url && url.indexOf(proxyDomain) <= -1){
            curTab.url = addProxyUrl(url);
          }
      }
    }

  </script>
</head>
<body>
</body>
</html>